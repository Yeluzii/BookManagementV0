<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.cjw.bookmanagementv0.mapper.RecordMapper">
    <insert id="add" parameterType="top.cjw.bookmanagementv0.entity.Record">
        insert into record(bookId,userId,borrowDatetime) value (#{bookId}, #{userId}, #{borrowDatetime})
    </insert>
    <select id="selectAll" resultType="top.cjw.bookmanagementv0.entity.Record">
        SELECT  *
        FROM record
    </select>
    <select id="selectByUsername"  resultMap="RecordResultMap">
        SELECT r.recordId, u.username, b.name, t.typeName, r.borrowDatetime
        FROM record r
                 INNER JOIN user u ON r.userId = u.userId
                 INNER JOIN book b ON r.bookId = b.bookId
                 INNER JOIN type t ON b.typeId = t.typeId
        WHERE u.username = #{username}
    </select>
    <resultMap id="RecordResultMap" type="top.cjw.bookmanagementv0.entity.Record">
        <id property="recordId" column="recordId"/>
        <result property="borrowDatetime" column="borrowDatetime"/>
        <association property="user" javaType="top.cjw.bookmanagementv0.entity.User">
            <id property="userId" column="userId"/>
            <result property="username" column="username"/>
        </association>
        <association property="book" javaType="top.cjw.bookmanagementv0.entity.Book">
            <id property="bookId" column="bookId"/>
            <result property="name" column="name"/>
        </association>
        <association property="type" javaType="top.cjw.bookmanagementv0.entity.Type">
            <id property="typeId" column="typeId"/>
            <result property="typeName" column="typeName"/>
        </association>
    </resultMap>



    <select id="selectByBookName" resultMap="RecordResultMap">
        SELECT  recordId,username,name,typeName
        FROM record,user,book,type
        WHERE record.userId = user.userId
          AND record.bookId = book.bookId
          AND book.typeId = type.typeId
          AND name like concat('%',#{name},'%')
    </select>

    <select id="findBorrowTimesByUsernameAndBookIdSpecific" resultMap="RecordResultMap2">
        SELECT recordId,r.bookId,username
        FROM record r
                 INNER JOIN user u ON r.userId = u.userId
                 INNER JOIN book b ON r.bookId = b.bookId
        WHERE u.username = #{username} AND r.bookId = #{bookId}
    </select>
    <resultMap id="RecordResultMap2" type="top.cjw.bookmanagementv0.entity.Record">
        <id property="recordId" column="recordId"/>
        <result property="borrowDatetime" column="borrowDatetime"/>
        <association property="user" javaType="top.cjw.bookmanagementv0.entity.User">
            <id property="userId" column="userId"/>
            <result property="username" column="username"/>
        </association>
        <association property="book" javaType="top.cjw.bookmanagementv0.entity.Book">
            <id property="bookId" column="bookId"/>
            <result property="name" column="name"/>
        </association>
    </resultMap>

</mapper>